<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Live-Confirmation Dashboard</title>

<style>
* { box-sizing: border-box; }

body {
  font-family: Arial, sans-serif;
  font-weight: bold;
  background: #fefefe;
  margin: 0;
  height: 100vh;
  overflow: hidden;
}

h2 {
  background: #1270c2;
  text-align: center;
  margin: 0;
  padding: 12px;
  color: white;
  position: sticky;
  top: 0;
  z-index: 100;
}

#summary {
  text-align: center;
  background: #1270c2;
  font-size: 1.2em;
  padding: 8px;
  color: white;
  position: sticky;
  top: 52px;
  z-index: 100;
}

.table-container {
  height: calc(100vh - 180px);
  overflow-y: hidden; /* REQUIRED for TV smoothness */
  padding: 10px;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 10px;
  border: 1px solid #ddd;
  font-size: 14px;
}

thead th {
  background: #f1f1f1;
  position: sticky;
  top: 0;
  z-index: 10;
}

.green-row { background: #006400 !important; color: white; }
.yellow-row { background: #FFD700 !important; color: black; }
.red-row { background: #8B0000 !important; color: white; }

.timer { font-size: 12px; display: block; }

.footer {
  text-align: center;
  font-size: 0.6em;
  color: gray;
}
</style>
</head>

<body>

<h2>üßë‚Äç‚öïÔ∏è CONFIRMATION TRACKING DASHBOARD üßë‚Äçüíª</h2>
<div id="summary">Total Invoices In Confirmation: 0</div>

<div class="table-container" id="scrollContainer">
<table id="invoiceTable">
<thead>
<tr>
<th>Invoice</th>
<th>Confirmation Time</th>
<th>Confirmer</th>
<th>Customer</th>
<th>Credit Terms</th>
<th>Route</th>
<th>Order Date</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="footer">
Last updated: <span id="lastUpdated"></span><br>
Designed and Managed by MIS.DPT
</div>

<script src="config.js"></script>

<script>
/* ------------------ FETCH + RENDER ------------------ */

const API_URL =
  window.API_CONFIG.API_URL +
  `list?status=ITEM_CONFIRMATION&orgBranchId=orgbranch-683976e3994a072a600cbd7a`;

const API_TOKEN = window.API_CONFIG.API_TOKEN;

async function fetchInvoices() {
  const res = await fetch(API_URL, {
    headers: { Authorization: API_TOKEN }
  });
  const json = await res.json();
  if (!json.data) return;
  renderTable(json.data);
  document.getElementById("lastUpdated").textContent =
    new Date().toLocaleTimeString();
}

function renderTable(data) {
  const tbody = document.querySelector("#invoiceTable tbody");
  tbody.innerHTML = "";
  document.getElementById("summary").textContent =
    `Total Invoices In Confirmation: ${data.length}`;

  data.forEach(item => {
    const t = new Date(item.orderConfirmationCheckinAt);
    const diffMin = (Date.now() - t) / 60000;

    const tr = document.createElement("tr");
    if (diffMin <= 10) tr.className = "green-row";
    else if (diffMin <= 20) tr.className = "yellow-row";
    else tr.className = "red-row";

    const id = `timer-${item.id}`;

    tr.innerHTML = `
      <td>${item.invoiceNumber}</td>
      <td>${t.toLocaleTimeString()}<span id="${id}" class="timer"></span></td>
      <td>${item.itemsConfirmedByName || "‚Äî"}</td>
      <td>${item.customerName}</td>
      <td>${item.creditTerm.replace(/_/g," ")}</td>
      <td>${item.routeName}</td>
      <td>${t.toLocaleDateString()}</td>
    `;
    tbody.appendChild(tr);
    startTimer(id, t);
  });
}

function startTimer(id, t) {
  function tick() {
    const m = Math.floor((Date.now() - t) / 60000);
    const h = Math.floor(m / 60);
    const el = document.getElementById(id);
    if (el) el.textContent = `In confirmation: ${h}h ${m % 60}m`;
  }
  tick();
  setInterval(tick, 60000);
}

/* ------------------ ANDROID TV AUTO SCROLL ------------------ */

const container = document.getElementById("scrollContainer");

let dir = 1;
let pos = 0;
let pauseUntil = 0;
const speed = 0.35; // pixels per frame (TV safe)

function autoScroll(ts) {
  if (ts < pauseUntil) {
    requestAnimationFrame(autoScroll);
    return;
  }

  const max = container.scrollHeight - container.clientHeight;
  pos += dir * speed;
  container.scrollTop = pos;

  if (pos >= max && dir === 1) {
    pos = max;
    dir = -1;
    pauseUntil = ts + 2000; // pause bottom
  }

  if (pos <= 0 && dir === -1) {
    pos = 0;
    dir = 1;
    pauseUntil = ts + 2000; // pause top
  }

  requestAnimationFrame(autoScroll);
}

requestAnimationFrame(autoScroll);

/* ------------------ REFRESH ------------------ */
fetchInvoices();
setInterval(fetchInvoices, 30000);
</script>

</body>
</html>
