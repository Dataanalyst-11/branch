<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Confirmer Performance Dashboard</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f6f9;
        margin: 0;
        padding: 0;
    }
    h1 {
        text-align: center;
        padding: 20px;
        background: #34495e;
        color: white;
        margin: 0;
    }
    table {
        width: 95%;
        margin: 20px auto;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    th, td {
        padding: 12px;
        text-align: center;
        border: 1px solid #ddd;
    }
    th {
        background: #2c3e50;
        color: white;
        font-size: 14px;
    }
    tr:hover {
        background: #f1f1f1;
    }

    /* NEW COLOR RULES */
    .score-high { background: #27ae60; color: white; }   /* >= 80% */
    .score-medium { background: #f1c40f; color: black; } /* 50–79% */
    .score-low { background: #e74c3c; color: white; }    /* < 50% */

    #lastUpdated {
        text-align: center;
        color: #555;
        font-size: 14px;
    }
</style>
</head>
<body>

<h1>Confirmer Performance Report</h1>
<p id="lastUpdated">Last updated: --</p>

<table id="performanceTable">
    <thead>
        <tr>
            <th>Confirmation Attendant</th>
            <th>Branch</th>
            <th>Total Orders</th>
            <th>Line Items</th>
            <th>Avg Items per Order</th>
            <th>Orders per Hour</th>
            <th>Efficiency Score (%)</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Load config -->
<script src="config.js"></script>

<script>
// =========================
// API Configuration
// =========================
let today = new Date();
let yyyy = today.getFullYear();
let mm = String(today.getMonth() + 1).padStart(2, '0');
let dd = String(today.getDate()).padStart(2, '0');
let formatted = `${yyyy}-${mm}-${dd}`;
//683976e3994a072a600cbd7a-Headoffice
const API_URL = window.API_CONFIG.API_URL +
  `order-confirmer-reports?orgBranchId=orgbranch-68458a4b76bd774c32f10527&startDate=${formatted}`;
const API_TOKEN = window.API_CONFIG.API_TOKEN;

// =========================
// Percentage Scoring Formula
// =========================
function calculatePerformance(attendant) {
  const hoursWorked = 8;
  const orders = attendant.numberOfOrders || 0;
  const items = attendant.numberOfLineItems || 0;
  const amount = attendant.orderAmount || 0;

  const avgItemsPerOrder = orders > 0 ? items / orders : 0;
  const ordersPerHour = orders / hoursWorked;
  const avgOrderValue = orders > 0 ? amount / orders : 0;

  // Normalize values (capped at 100%)
  const scoreOrders = Math.min((ordersPerHour / 20) * 100, 100);       // 0–20 orders/hr
  const scoreItems  = Math.min((avgItemsPerOrder / 10) * 100, 100);    // 0–10 items/order
  const scoreValue  = Math.min((avgOrderValue / 5000) * 100, 100);     // 0–5000 KES/order

  // Weighted final percentage
  const finalScore = (
    (scoreOrders * 0.4) +
    (scoreItems  * 0.3) +
    (scoreValue  * 0.3)
  );

  return {
    avgItemsPerOrder,
    avgOrderValue,
    ordersPerHour,
    score: finalScore
  };
}

function scoreClass(score) {
  if (score >= 80) return "score-high";
  if (score >= 50) return "score-medium";
  return "score-low";
}

// =========================
// Load and Render Data
// =========================
async function loadPerformanceData() {
  const tbody = document.querySelector("#performanceTable tbody");
  tbody.innerHTML = "<tr><td colspan='9'>Loading data...</td></tr>";

  try {
    const response = await fetch(API_URL, {
      headers: {
        "Authorization": API_TOKEN,
        "Content-Type": "application/json"
      }
    });

    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

    const json = await response.json();
    const attendants = Array.isArray(json) ? json : json.data || [];

    if (attendants.length === 0) {
      tbody.innerHTML = "<tr><td colspan='9'>No data available</td></tr>";
      return;
    }

    const rows = attendants.map(a => {
      const p = calculatePerformance(a);
      return `
        <tr>
          <td>${a.itemsConfirmedByName}</td>
          <td>${a.orgBranchName}</td>
          <td>${a.numberOfOrders}</td>
          <td>${a.numberOfLineItems}</td>
          <td>${p.avgItemsPerOrder.toFixed(2)}</td>
          <td>${p.ordersPerHour.toFixed(2)}</td>
          <td class="${scoreClass(p.score)}">${p.score.toFixed(1)}%</td>
        </tr>`;
    }).join('');

    tbody.innerHTML = rows;
    document.getElementById("lastUpdated").textContent =
      "Last updated: " + new Date().toLocaleTimeString();

  } catch (error) {
    console.error("Failed to load data:", error);
    tbody.innerHTML = `<tr><td colspan='9' style='color:red;'>Error loading data</td></tr>`;
  }
}

loadPerformanceData();
</script>

</body>
</html>
