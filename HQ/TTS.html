<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Live-Store Invoice Dashboard</title>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: Arial, sans-serif;
  font-weight: bold;
  background: #fefefe;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

h2 {
  background: #054eed;
  text-align: center;
  margin: 0;
  padding: 12px;
  color: white;
  position: sticky;
  top: 0;
  z-index: 100;
}

#summary {
  text-align: center;
  background: #417dfe;
  font-size: 1.2em;
  padding: 8px;
  color: white;
  position: sticky;
  top: 52px;
  z-index: 100;
}

.table-container {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

th, td {
  padding: 10px;
  border: 1px solid #ddd;
  text-align: left;
  font-size: 14px;
}

thead th {
  background: #f1f1f1;
  position: sticky;
  top: 0;
  z-index: 10;
}

.green-row { background:#006400 !important; color:white; }
.yellow-row { background:#FFD700 !important; color:black; }
.red-row { background:#8B0000 !important; color:white; }

.timer {
  display:block;
  font-size:13px;
  margin-top:4px;
}

.footer {
  text-align:center;
  font-size:12px;
  padding:6px;
  color:gray;
}

#ttsBtn {
  position: fixed;
  top: 10px;
  right: 10px;
  padding: 6px 12px;
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
  font-weight: bold;
  cursor: pointer;
  z-index: 1000;
}
</style>
</head>

<body>

<h2>üè¨ STORE TRACKING DASHBOARD</h2>
<div id="summary">Total Invoices In Store: 0</div>

<button id="ttsBtn">‚ñ∂ Start Voice Alerts</button>

<div class="table-container">
<table id="invoiceTable">
<thead>
<tr>
<th>Invoice</th>
<th>STORE TIME IN</th>
<th>STORE EXECUTIVE</th>
<th>Customer Name</th>
<th>Credit Terms</th>
<th>Route</th>
<th>Order Date</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="footer">
Last updated: <span id="lastUpdated">--</span>
<div>Designed and Managed by MIS.DPT</div>
</div>

<script src="config.js"></script>

<script>
/* ================= CONFIG ================= */

const API_URL = window.API_CONFIG.API_URL +
`list?status=STORE_CHECKED_IN&orgBranchId=orgbranch-683976e3994a072a600cbd7a&startDate=${new Date().toISOString().split('T')[0]}`;

const API_TOKEN = window.API_CONFIG.API_TOKEN;

const tbody = document.querySelector("#invoiceTable tbody");
const summaryEl = document.getElementById("summary");
const lastUpdatedEl = document.getElementById("lastUpdated");
const container = document.querySelector(".table-container");

/* ================= TTS ENGINE (HARDENED) ================= */

let ttsActivated = false;
let femaleVoice = null;
let speakQueue = [];
let isSpeaking = false;
let lastSpeechTime = Date.now();
let activeRedInvoices = new Map(); // id -> last spoken minute

/* -------- Load Voices Safely -------- */

function loadVoices() {
  const voices = speechSynthesis.getVoices();
  femaleVoice =
    voices.find(v => v.name.includes("Female")) ||
    voices.find(v => v.name.includes("Google")) ||
    voices[0];
}
speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

/* -------- Activate TTS -------- */

document.getElementById("ttsBtn").addEventListener("click", () => {
  if (ttsActivated) return;

  speechSynthesis.cancel();
  speechSynthesis.speak(new SpeechSynthesisUtterance(""));

  ttsActivated = true;
  document.getElementById("ttsBtn").textContent = "üéß Voice Active";
  document.getElementById("ttsBtn").style.background = "#2196F3";
});

/* -------- Speech Queue -------- */

function queueSpeech(text) {
  if (!ttsActivated) return;

  // Prevent queue explosion
  if (speakQueue.length > 10) return;

  speakQueue.push(text);
  processSpeechQueue();
}

function processSpeechQueue() {
  if (!ttsActivated || isSpeaking || speakQueue.length === 0) return;

  if (!femaleVoice) loadVoices();

  const message = speakQueue.shift();
  const utter = new SpeechSynthesisUtterance(message);

  if (femaleVoice) utter.voice = femaleVoice;

  utter.rate = 1;
  utter.pitch = 1;

  isSpeaking = true;
  lastSpeechTime = Date.now();

  utter.onend = () => {
    isSpeaking = false;
    lastSpeechTime = Date.now();
    processSpeechQueue();
  };

  utter.onerror = () => {
    isSpeaking = false;
    processSpeechQueue();
  };

  speechSynthesis.speak(utter);
}

/* -------- Watchdog (Self-Healing) -------- */

setInterval(() => {

  if (!ttsActivated) return;

  // If engine stuck
  if (isSpeaking && !speechSynthesis.speaking) {
    isSpeaking = false;
    processSpeechQueue();
  }

  // If speech engine froze for 30+ seconds
  if (Date.now() - lastSpeechTime > 30000 && speakQueue.length > 0) {
    speechSynthesis.cancel();
    isSpeaking = false;
    processSpeechQueue();
  }

}, 5000);

/* ================= FORMAT INVOICE ================= */

function formatInvoiceForSpeech(inv) {
  if (!inv || inv.length < 4) return inv;

  const firstThree = inv.slice(0,3).split("").join(" ");

  const lastFour = inv.slice(-4)
    .split("")
    .map(n => {
      const nums = ["zero","one","two","three","four","five","six","seven","eight","nine"];
      return nums[n] ?? n;
    })
    .join(" ");

  return `${firstThree} ${lastFour}`;
}

/* ================= FETCH ================= */

async function fetchInvoices() {
  try {
    const response = await fetch(API_URL, {
      headers: { Authorization: API_TOKEN }
    });

    if (!response.ok) throw new Error("API error");

    const json = await response.json();
    const data = Array.isArray(json) ? json : json.data || [];

    renderTable(data);
    lastUpdatedEl.textContent = new Date().toLocaleTimeString();

  } catch (err) {
    console.error("Fetch error:", err);
  }
}

/* ================= RENDER ================= */

function renderTable(data) {

  tbody.innerHTML = "";
  summaryEl.textContent = `Total Invoices In Store: ${data.length}`;

  const visibleIds = new Set();

  data.forEach(item => {

    if (!item.storeCheckinAt) return;

    const checkin = new Date(item.storeCheckinAt);
    const diffMinutes = Math.floor((Date.now() - checkin.getTime()) / 60000);

    const row = document.createElement("tr");
    row.dataset.id = item.id;
    row.dataset.checkin = checkin.getTime();

    visibleIds.add(item.id);

    updateRowColor(row, diffMinutes);

    addCell(row, item.invoiceNumber);
    addTimeCell(row, checkin);
    addCell(row, item.storePickerName || "‚Äî");
    addCell(row, item.customerName || "‚Äî");
    addCell(row, (item.creditTerm || "").replace(/_/g," "));
    addCell(row, item.routeName || "‚Äî");
    addCell(row, checkin.toLocaleDateString());

    tbody.appendChild(row);

    handleRedInvoice(item, diffMinutes);
  });

  cleanupInactiveInvoices(visibleIds);
}

function addCell(row,text){
  const td=document.createElement("td");
  td.textContent=text||"‚Äî";
  row.appendChild(td);
}

function addTimeCell(row,timeObj){
  const td=document.createElement("td");
  const timeText=document.createElement("div");
  timeText.textContent=timeObj.toLocaleTimeString([],{
    hour:"2-digit",minute:"2-digit"
  });
  const timer=document.createElement("span");
  timer.className="timer";
  td.appendChild(timeText);
  td.appendChild(timer);
  row.appendChild(td);
}

function updateRowColor(row,mins){
  row.classList.remove("green-row","yellow-row","red-row");
  if(mins<=10) row.classList.add("green-row");
  else if(mins<=20) row.classList.add("yellow-row");
  else row.classList.add("red-row");
}

/* ================= RED ALERT LOGIC ================= */

function handleRedInvoice(item, diffMinutes) {

  if (diffMinutes <= 20) {
    activeRedInvoices.delete(item.id);
    return;
  }

  const lastMinuteSpoken = activeRedInvoices.get(item.id);

  if (lastMinuteSpoken === undefined || diffMinutes > lastMinuteSpoken) {

    const delay = diffMinutes - 20;
    const spokenInvoice = formatInvoiceForSpeech(item.invoiceNumber);
    const picker = item.storePickerName || "Staff";

    const message =
      `${picker}, invoice ${spokenInvoice} has delayed for ` +
      `${delay} minute${delay !== 1 ? "s" : ""}. ` +
      `Kindly be fast.`;

    queueSpeech(message);

    activeRedInvoices.set(item.id, diffMinutes);
  }
}

function cleanupInactiveInvoices(visibleIds){
  for (const id of activeRedInvoices.keys()) {
    if (!visibleIds.has(id)) {
      activeRedInvoices.delete(id);
    }
  }
}

/* ================= TIMER UPDATE ================= */

function updateTimers(){
  const rows=tbody.querySelectorAll("tr");
  rows.forEach(row=>{
    const timestamp=Number(row.dataset.checkin);
    if(!timestamp) return;

    const diff=Math.floor((Date.now()-timestamp)/60000);
    const hrs=Math.floor(diff/60);
    const mins=diff%60;

    const timer=row.querySelector(".timer");
    if(timer){
      timer.textContent=`In store for: ${hrs}h ${mins}m`;
    }

    updateRowColor(row,diff);
  });
}

/* ================= AUTO SCROLL ================= */

let direction=1;
let paused=false;

function pause(ms){
  paused=true;
  setTimeout(()=>paused=false,ms);
}

setInterval(()=>{
  if(paused) return;

  const max=container.scrollHeight-container.clientHeight;
  const next=container.scrollTop+direction;

  if(next>=max){
    direction=-1;
    pause(4000);
  }
  else if(next<=0){
    direction=1;
    pause(5000);
  }
  else{
    container.scrollTop=next;
  }
},20);

/* ================= INIT ================= */

fetchInvoices();
setInterval(fetchInvoices,30000);
setInterval(updateTimers,10000);

</script>


</body>
</html>
