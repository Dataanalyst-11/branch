<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Live-Store Invoice Dashboard</title>

<style>
  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: Arial, sans-serif;
    font-weight: bold;
    background: #fefefe;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  h2 {
    background: #054eed;
    text-align: center;
    margin: 0;
    padding: 12px;
    color: white;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  #summary {
    text-align: center;
    background: #417dfe;
    font-size: 1.2em;
    padding: 8px;
    color: white;
    position: sticky;
    top: 52px;
    z-index: 100;
  }

  .table-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }

  th, td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: left;
    font-size: 14px;
    vertical-align: top;
  }

  thead th {
    background-color: #f1f1f1;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  tr:nth-child(even) { background-color: #fafafa; }

  .green-row { background-color: #006400 !important; color: white; }
  .yellow-row { background-color: #FFD700 !important; color: black; }
  .red-row { background-color: #8B0000 !important; color: white; }

  .timer {
    display: block;
    font-size: 13px;
    margin-top: 4px;
  }

  .footer {
    text-align: center;
    font-size: 12px;
    padding: 6px;
    color: gray;
  }
</style>
</head>

<body>

<h2>üè¨ STORE TRACKING DASHBOARD</h2>
<div id="summary">Total Invoices In Store: 0</div>

<div class="table-container">
  <table id="invoiceTable">
    <thead>
      <tr>
        <th>Invoice</th>
        <th>STORE TIME IN</th>
        <th>STORE EXECUTIVE</th>
        <th>Customer Name</th>
        <th>Credit Terms</th>
        <th>Route</th>
        <th>Order Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="footer">
  Last updated: <span id="lastUpdated">--</span>
  <div>Designed and Managed by MIS.DPT</div>
</div>

<script src="config.js"></script>

<script>
/* ================================
   CONFIG
================================ */

const API_URL = window.API_CONFIG.API_URL +
  `list?status=STORE_CHECKED_IN&orgBranchId=orgbranch-683976e3994a072a600cbd7a&startDate=${new Date().toISOString().split('T')[0]}`;

const API_TOKEN = window.API_CONFIG.API_TOKEN;

const tbody = document.querySelector("#invoiceTable tbody");
const summaryEl = document.getElementById("summary");
const lastUpdatedEl = document.getElementById("lastUpdated");
const container = document.querySelector(".table-container");

/* ================================
   FETCH DATA
================================ */

async function fetchInvoices() {
  try {
    const response = await fetch(API_URL, {
      headers: {
        "Authorization": API_TOKEN,
        "Content-Type": "application/json"
      }
    });

    if (!response.ok) {
      throw new Error(`API Error ${response.status}`);
    }

    const json = await response.json();
    const data = Array.isArray(json) ? json : json.data || [];

    renderTable(data);
    updateAllTimers(); // immediate update
    lastUpdatedEl.textContent = new Date().toLocaleTimeString();

  } catch (err) {
    console.error("Fetch error:", err);
  }
}

/* ================================
   RENDER TABLE
================================ */

function renderTable(data) {
  tbody.innerHTML = "";
  summaryEl.textContent = `Total Invoices In Store: ${data.length}`;

  data.forEach(item => {
    if (!item.storeCheckinAt) return;

    const checkinTime = new Date(item.storeCheckinAt);
    const row = document.createElement("tr");
    row.dataset.checkin = checkinTime.getTime();

    addCell(row, item.invoiceNumber);
    addTimeCell(row, checkinTime);
    addCell(row, item.storePickerName || "‚Äî");
    addCell(row, item.customerName || "‚Äî");
    addCell(row, (item.creditTerm || "").replace(/_/g, " "));
    addCell(row, item.routeName || "‚Äî");
    addCell(row, checkinTime.toLocaleDateString());

    tbody.appendChild(row);
  });
}

function addCell(row, text) {
  const td = document.createElement("td");
  td.textContent = text || "‚Äî";
  row.appendChild(td);
}

function addTimeCell(row, timeObj) {
  const td = document.createElement("td");

  const timeText = document.createElement("div");
  timeText.textContent = timeObj.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit"
  });

  const timerSpan = document.createElement("span");
  timerSpan.className = "timer";

  td.appendChild(timeText);
  td.appendChild(timerSpan);
  row.appendChild(td);
}

/* ================================
   GLOBAL TIMER (NO LEAK)
================================ */

function updateAllTimers() {
  const rows = tbody.querySelectorAll("tr");

  rows.forEach(row => {
    const timestamp = Number(row.dataset.checkin);
    if (!timestamp) return;

    const diffMs = Date.now() - timestamp;
    const totalMinutes = Math.floor(diffMs / 60000);
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;

    const timerEl = row.querySelector(".timer");
    if (timerEl) {
      timerEl.textContent = `In store for: ${hours}h ${minutes}m`;
    }

    updateRowColor(row, totalMinutes);
  });
}

function updateRowColor(row, diffMinutes) {
  row.classList.remove("green-row", "yellow-row", "red-row");

  if (diffMinutes <= 10) row.classList.add("green-row");
  else if (diffMinutes <= 20) row.classList.add("yellow-row");
  else row.classList.add("red-row");
}

/* ================================
   AUTO SCROLL (4s BOTTOM PAUSE)
================================ */

let scrollDirection = 1;
const SCROLL_SPEED = 1;
const TOP_PAUSE = 5000;
const BOTTOM_PAUSE = 4000; // ‚úÖ 4 seconds
let paused = false;

function pauseScroll(ms) {
  paused = true;
  setTimeout(() => paused = false, ms);
}

setInterval(() => {
  if (paused) return;

  const maxScroll = container.scrollHeight - container.clientHeight;
  const next = container.scrollTop + scrollDirection * SCROLL_SPEED;

  if (next >= maxScroll) {
    scrollDirection = -1;
    pauseScroll(BOTTOM_PAUSE);
  } 
  else if (next <= 0) {
    scrollDirection = 1;
    pauseScroll(TOP_PAUSE);
  } 
  else {
    container.scrollTop = next;
  }
}, 20);

/* ================================
   INIT
================================ */

fetchInvoices();
setInterval(fetchInvoices, 30000);   // Refresh data every 30s
setInterval(updateAllTimers, 30000); // Update timers every 30s (smooth)

</script>

</body>
</html>
